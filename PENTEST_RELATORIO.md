## Relatório de Conformidade – Ajustes pós PENTEST

### Escopo
- Projeto: `dps-web`
- Objetivo: Atender às recomendações do relatório de PENTEST com endurecimento de headers, correção do formulário de login e redução de fingerprinting de tecnologia.

---

### Itens do PENTEST corrigidos

- **[1] X-Content-Type-Options ausente**
  - **Ação**: Adicionado `X-Content-Type-Options: nosniff` globalmente.
  - **Arquivo**: `next.config.mjs`
  - **Ganho**: Evita MIME-sniffing e execução indevida de conteúdo.

- **[2] Referrer-Policy ausente**
  - **Ação**:
    - Header `Referrer-Policy: no-referrer` aplicado globalmente.
    - Metadado do app definido: `referrer: 'no-referrer'`.
  - **Arquivos**: 
    - `next.config.mjs`
    - `src/app/layout.tsx`
  - **Ganho**: Impede envio do cabeçalho Referer, evitando vazamento de URLs e parâmetros sensíveis.

- **[3] Content-Security-Policy (CSP) ausente**
  - **Ação**: Implementada CSP via middleware; removida CSP estática do `next.config.mjs`.
  - **Arquivo**: `src/middleware.ts`
  - **Diretivas atuais (conforme código)**:
    - `default-src 'self' blob: data:`
    - `base-uri 'self'`
    - `frame-ancestors 'self'`
    - `form-action 'self'`
    - `object-src 'none'`
    - `img-src 'self' data: blob: https:`
    - `font-src 'self' data: https:`
    - `script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data:`
    - `style-src 'self' 'unsafe-inline' https:`
    - `frame-src 'self' blob: data:`
    - `child-src 'self' blob: data:`
    - `worker-src 'self' blob:`
    - `connect-src 'self' https: ws: wss: ${ORIGENS_DA_API}` (origens derivadas de `NEXT_PUBLIC_API_BASE_URL` quando válida)
  - **Ganho**: Controla origens de recursos, permite exibição de PDFs (blob/data) e mantém compatibilidade com a aplicação.

- **[4] Senha submetida na URL (form GET)**
  - **Ação**:
    - O envio de credenciais é feito via `signIn('credentials')` (NextAuth), que realiza POST; o `<form>` não envia por GET.
    - `autocomplete` padronizado para `username` e `current-password`.
  - **Arquivo**: `src/app/(login-area)/components/login-form.tsx`
  - **Ganho**: Evita exposição de senha em URL, histórico e logs, mantendo a UX atual.

- **[5] Exposição de tecnologias do servidor**
  - **Ação**: Desativado `X-Powered-By` do Next.
  - **Arquivo**: `next.config.mjs` (`poweredByHeader: false`)
  - **Ganho**: Reduz fingerprinting automático de tecnologia (não elimina inferência por heurística, mas dificulta).

---

### Endurecimento adicional aplicado

- **X-Frame-Options: SAMEORIGIN**
  - Previne cliquejacking.

- **Permissions-Policy**
  - Desabilita por padrão: `camera`, `microphone`, `geolocation`.

- **COOP/CORP**
  - `Cross-Origin-Opener-Policy: same-origin`
  - `Cross-Origin-Resource-Policy: same-origin`
  - Melhora isolamento e reduz canais de interferência cross-origin.

- **Rate limiting de login**
  - Implementado controle de tentativas: 10 requisições/minuto por IP em `POST /api/auth/*`.
  - **Arquivo**: `src/middleware.ts`
  - **Ganho**: Mitiga brute-force e enumeração de credenciais.

- **CSP no middleware**
  - Header `Content-Security-Policy` aplicado pelo middleware com as diretivas listadas acima.
  - **Arquivo**: `src/middleware.ts`
  - **Observação**: Política atual utiliza `'unsafe-inline'/'unsafe-eval'` para compatibilidade; pode ser endurecida futuramente com nonce.

- **Correções de exibição de PDF (modal)**
  - Permissões adicionadas na CSP para `frame-src`/`child-src`/`worker-src` com `blob:`/`data:` para permitir visualização de PDFs no modal.
  - **Arquivo**: `src/middleware.ts`
  - **Ganho**: Mantém segurança e permite exibição de documentos em `DialogShowArchive`.

---

### Arquivos alterados

- `next.config.mjs`
  - Headers: `X-Content-Type-Options`, `Referrer-Policy`, `X-Frame-Options`, `Permissions-Policy`, `Cross-Origin-Opener-Policy`, `Cross-Origin-Resource-Policy`
  - Ofuscação: `poweredByHeader: false`
  - Observação: CSP é definida pelo middleware (não há nonce atualmente).

- `src/app/(login-area)/components/login-form.tsx`
  - Form: `method="post"`
  - Autocomplete: `username` / `current-password`

- `src/middleware.ts`
  - Rate limiting para `POST /api/auth/*` e preservação do fluxo público/privado via `withAuth`.
  - CSP dinâmica com nonce por requisição.

- `src/app/api/auth/[...nextauth]/auth-options.ts`
  - Validação de `NEXT_PUBLIC_API_BASE_URL` antes de construir URLs; falha explícita quando inválida.

- `src/lib/axios.ts`
  - `baseURL` resiliente: ignora env inválida (`null`, `undefined`, sem http/https`).

- `src/app/(logged-area)/dps/components/dialog-archive.tsx`
  - Acessibilidade: adicionado `AlertDialogTitle` oculto com `VisuallyHidden`.
  - Robustez: normalização de base64 (URL-safe e padding) ao gerar `blob:` para PDFs; `referrerPolicy="no-referrer"` no `iframe`.

- `src/app/layout.tsx`
  - Metadado: `referrer: 'no-referrer'`

---

### Benefícios obtidos

- Menos vazamento de dados: `Referrer-Policy` e remoção do `X-Powered-By`.
- Superfície de ataque reduzida: CSP restringe origens de recursos; `X-Content-Type-Options` e `X-Frame-Options` ativam defesas padrão.
- Proteção de credenciais: envio de senha via POST, evitando exposição em URL e logs.
- Isolamento de contexto: COOP/CORP para cenários de múltiplas origens.

---

### Notas e próximos passos

- CSP: As diretivas atuais refletem o estado do código. Se precisar endurecer, considerar migrar gradualmente para uso de `nonce` e remover `'unsafe-inline'/'unsafe-eval'` quando viável. Caso novos domínios sejam usados (CDN, fontes, scripts), adicione-os às diretivas correspondentes (`img-src`, `font-src`, `script-src`, `connect-src`, etc.).
- Auditoria e monitoramento: Recomenda-se integrar varreduras periódicas (OWASP ZAP baseline, npm audit) no pipeline de CI.
- Rate limiting (opcional): adicionar limitação de tentativas no login/rotas sensíveis para fortalecer contra brute-force.

